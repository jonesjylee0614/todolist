# 技术设计文档

> **目标**：基于已有原型，构建一个支持 PC 与移动端的 Todo List 应用。前端采用 Vue 生态，后端采用 Go + MySQL 5.7 + ORM，实现全量接口与撤销能力，保障多端一致体验与可扩展性。

---

## 0. 概述

- **产品形态**：单页 Web 应用（SPA），通过响应式布局兼容桌面与移动端。
- **核心模块**：现在（Now）/未来（Future）/历史（History）三个任务视图，任务 CRUD、拖拽移动、批量操作、搜索、撤销。
- **部署方式**：前端静态资源（Vite 构建），后端 Go 服务（容器部署），持久化到 MySQL 5.7。
- **开发目标**：保证排序规则、撤销体验、本地与后端状态一致性；留出未来扩展（多用户、推送等）的接口空间。

---

## 1. 技术栈选型

### 1.1 前端栈（PC + 移动端）

- **Vue 3 + `<script setup>` + TypeScript** ：组合式 API，类型约束提升可维护性。
- **Vite 5**：极速开发与构建，原生 ES 模块，支持多环境配置。
- **Pinia**：官方推荐状态管理，模块化 store，支持插件扩展（如撤销栈、持久化）。
- **Vue Router 4**：管理「现在/未来/历史」与设置、帮助等潜在页面。
- **Axios**：统一请求层，封装拦截器处理鉴权、错误提示、撤销 token。
- **`@headlessui/vue` + UnoCSS（或 Tailwind CSS）**：Headless 组件保证交互无障碍，原子化样式快速实现自定义 UI；结合 CSS 变量实现暗/亮主题。
- **Vue Draggable Plus（基于 SortableJS）**：支持跨列表拖拽、触屏操作；配合自定义拖拽占位与键盘辅助导航。
- **Day.js**：轻量日期处理，格式化“今天/明天/日期”。
- **`@vueuse/core` + `@vueuse/motion`**：常用组合式工具（媒体查询、快捷键、剪贴板）及动效能力。
- **Vitest + Vue Testing Library + Playwright**：单元/组件/端到端测试。

### 1.2 响应式设计与多端适配

- 单代码基，通过 CSS Clamp + 自定义断点实现三段布局（≥1280px 桌面、768–1279px 平板、<768px 移动）。
- 使用 CSS Grid 控制主面板/抽屉布局；移动端将抽屉改为全屏 Sheet。
- 组件内使用 `useBreakpoints`（VueUse）监听断点，动态切换交互（如移动端改为底部操作条、滑动手势）。
- 触屏优化：拖拽专用句柄、长按进入多选、滑动快捷操作。

### 1.3 后端与基础设施

- **Go 1.22**：高性能、并发友好；模块化便于扩展。
- **Gin**：轻量 HTTP 框架，路由中间件丰富。
- **GORM**：主流 ORM，支持 MySQL 5.7，带迁移工具。
- **MySQL 5.7**：满足排序、事务、JSON 字段需求；兼容未来扩展。
- **sqlc & migrations**（可选）：如需手写 SQL 与代码生成；本阶段使用 GORM AutoMigrate + 手写迁移脚本。
- **Viper**：配置管理，支持多环境切换（dev/staging/prod）。
- **Zap + Lumberjack**：结构化日志与滚动保存。
- **go-playground/validator**：请求体验证。
- **Docker + docker-compose**：本地一键启动后端与数据库。

### 1.4 工具链与质量控制

- **Lint**：ESLint + Prettier（前端）、golangci-lint（后端）。
- **测试**：前端 Vitest 覆盖关键 Hook & 组件，后端 go test + testify。
- **Commit 规范**：Conventional Commits。
- **CI/CD**：GitHub Actions（或等价）运行 lint/test/build；构建 Docker 镜像。

---

## 2. 整体架构

```
┌────────────────────────── SPA (Vite 构建) ───────────────────────────┐
│  Vue Router  │  Pinia Store  │  Axios 客户端  │  组件/指令  │  Undo 管理  │
└───────────────────────────────▲─────────────────────────────────────┘
                                │ HTTPS / JSON (REST)
┌───────────────────────────────┴─────────────────────────────────────┐
│                           Go Backend (Gin)                         │
│  路由层  │  控制器  │  Service  │  Repository  │ Undo Token │ 日志/监控 │
└───────────────────────────────▲─────────────────────────────────────┘
                                │ GORM + SQL
┌───────────────────────────────┴─────────────────────────────────────┐
│                           MySQL 5.7 数据库                          │
│  tasks  │  task_operations  │  task_activity_logs  │  migrations   │
└────────────────────────────────────────────────────────────────────┘
```

- **数据流**：前端操作 → REST 请求 → Service 校验业务规则 → Repository 事务 → MySQL → 返回任务数据 + 撤销 token → Pinia 更新 + Toast。
- **排序职责**：任务排序规则由后端实现（SQL + Service），保证多端一致；前端只做展示与本地缓存。
- **撤销机制**：后端返回 `undoToken`（5 秒有效），前端在 Toast 中触发 `POST /api/v1/undo` 完成回滚。

---

## 3. 前端架构设计

### 3.1 目录结构

```
src/
  main.ts             // 入口
  App.vue             // 顶层布局 + 响应式容器
  router/
    index.ts          // 路由配置（支持 Hash / History）
  stores/
    tasks.ts          // 任务数据、排序、撤销
    ui.ts             // 抽屉状态、Toast、容量提示
    selection.ts      // 多选、快捷键状态
  modules/
    tasks/
      pages/
        NowView.vue
        FutureView.vue
        HistoryView.vue
      components/
        TaskBoard.vue         // 主列表容器
        TaskColumn.vue        // 可复用列容器
        TaskCard.vue
        TaskActions.vue
        TaskDrawer.vue
        TaskQuickAdd.vue
        TaskSearch.vue
        CapacityHint.vue
      hooks/
        useTaskForm.ts
        useDragAndDrop.ts
        useUndoToast.ts
    settings/
      ...
  services/
    http.ts            // Axios 实例 + 拦截器
    taskApi.ts         // 与后端接口一一对应
  utils/
    date.ts            // 今日/明日格式化
    sort.ts            // 备用排序 & 权重计算
    device.ts          // 断点工具
  styles/
    tokens.css         // CSS 变量 & 主题
    index.css          // UnoCSS 入口
  tests/
    unit/
    components/
    e2e/
```

### 3.2 布局与路由

- **桌面端**：左右三列（Now / Future / History）+ 可折叠抽屉；Now 默认铺满，Future 与 History 以抽屉/侧栏显示。
- **平板/移动端**：单列主视图 + 底部 Tab；Future/History 以全屏抽屉呈现；顶部输入框收纳在浮动 FAB。
- **Quick Add**：顶部输入框支持 `Enter` → Future、`Shift+Enter` → Now；移动端在底部浮动按钮。
- **搜索**：全局搜索框位于/header 或命令面板；移动端使用全屏弹层。

### 3.3 状态管理

- `tasksStore`
  - `tasksById: Record<string, Task>`
  - `listIds: { now: string[]; future: string[]; history: string[] }`
  - `loadTasks(status)`：从后端拉取并归并。
  - `createTask(payload)`：调用 `POST /tasks`，根据响应更新列表。
  - `moveTask({ id, targetStatus })`：调用 `PATCH /tasks/:id/status`，局部更新 + 排序。
  - `completeTask(ids)`：调用单个/批量接口。
  - `setOrder(status, ids)`：本地更新顺序，并以节流方式调用 `POST /tasks/order`。
  - `applyUndo(token)`：等待后端回滚成功后刷新受影响列表。
- `uiStore`
  - 控制 Drawer、Toast、容量提醒、加载状态。
- `selectionStore`
  - 管理多选集合（set），记录最后选中 ID；键盘操作（`N`、`Shift+N`、`/`、`1/2/3`、`C`、`M`、`D`、`Delete`、`Ctrl+Z`）集中处理。
- **插件**：
  - `createUndoPlugin`：记录最近操作（ID、payload、返回的 undoToken）用于 Toast。
  - `persistedState`：仅缓存 UI 状态与 `listIds`，不缓存任务详情，避免数据陈旧。

### 3.4 数据获取与缓存

- 请求层统一通过 `taskApi.ts`。
- 使用 SWR（stale-while-revalidate）策略：初次加载走缓存，随后刷新后端数据。
- 幂等请求（如排序）采用乐观更新 + 失败回滚。
- 错误处理：Axios 拦截器将 4xx/5xx 转换为 `AppError`，并抛到 Toast。

### 3.5 交互实现

- **拖拽**：
  - `Vue Draggable Plus` 绑定在 `TaskColumn`；跨列需设置 `group`。
  - 拖动结束触发 `onEnd` → 分析源/目标列，调用合适的 API。
  - 键盘辅助：监听 `Space`/`Enter` 进入拖拽模式，使用方向键移动，确保无障碍。
- **批量操作**：
  - `selectionStore` 保存选中集合。
  - 批量移动/完成/删除通过 `/tasks/bulk/*` 接口，一次性刷新。
- **撤销**：
  - API 响应带 `undoToken`。
  - Toast 显示「撤销」按钮，调用 `POST /undo` 完成回滚，返回新的任务快照。

### 3.6 无障碍与可观测

- 所有交互点绑定 ARIA 属性（列表 role、按钮、拖拽提示）。
- Toast 通过 live region 通知屏幕阅读器。
- 前端埋点：页面停留、任务完成次数，发送到后端 `/analytics`（预留）。

---

## 4. 后端架构设计

### 4.1 目录结构

```
backend/
  go.mod
  main.go
  internal/
    app/
      routes/
        router.go          // 注册路由与中间件
      handler/
        task_handler.go    // HTTP 层，参数验证
        undo_handler.go
      dto/
        task_request.go    // 请求&响应模型
        task_response.go
      middleware/
        cors.go
        request_id.go
        logger.go
        recovery.go
    domain/
      task/
        model.go           // 领域实体
        service.go         // 业务规则（排序、容量提醒）
      undo/
        service.go
    repository/
      task_repository.go   // 与数据库交互
      undo_repository.go
    infra/
      config/
        config.go
      db/
        mysql.go           // GORM 初始化 & 迁移
      logger/
        logger.go
    pkg/
      response/
  migrations/
    0001_create_tasks.sql
    0002_create_task_operations.sql
    ...
```

### 4.2 层次职责

- **Handler**：接收 HTTP 请求、绑定参数、调用 Service、构造响应。
- **Service**：封装业务规则（排序、状态流转、撤销、容量校验），维护事务边界。
- **Repository**：操作数据库，返回领域模型；使用 GORM + context。
- **Domain**：纯业务逻辑（排序算法、状态枚举、错误定义）。
- **Infra**：日志、配置、数据库连接、熔断器。

### 4.3 核心流程

1. **创建任务**
   - Handler 校验标题、分组（默认 future），调用 Service。
   - Service 生成 `sort_weight`（当前时间戳 + 随机偏移），事务内写入 `tasks` 表，并记录操作到 `task_operations`。
   - 返回任务详情 + `undoToken`。

2. **移动/完成任务**
   - 对单个任务使用 `PATCH /tasks/:id/status` 或 `POST /tasks/:id/complete`。
   - Service 校验合法流转（future → now/history, now → history）。
   - 计算新排序权重（目标列末尾 或 遵循截止日规则）。
   - 触发操作日志、生成撤销 token。

3. **批量操作**
   - Handler 接收 `ids[]`，Service 启动事务批量更新；失败则整体回滚。

4. **撤销**
   - Undo Service 根据 `undoToken` 查找 `task_operations` 快照，恢复 `tasks` 数据。
   - 为避免重复撤销，token 使用一次后立即失效（`consumed_at` 填充）。

5. **排序规则实现**
   - SQL 查询按以下顺序排序：
     - `status = 'now'`: deadline 是否为空、deadline 升序、`sort_weight` 升序。
     - `status = 'future'`: deadline 是否为空、deadline 升序、`sort_weight` 升序。
     - `status = 'history'`: `completed_at` DESC。

### 4.4 中间件

- `RequestID`：为每个请求生成 UUID，方便日志关联。
- `Logger`：记录响应时间、状态码；错误写入结构化日志。
- `Recovery`：捕获 panic，返回 500 JSON。
- `CORS`：允许前端域访问。
- `RateLimit`（可选）：防止恶意操作。

### 4.5 配置

- `config.yaml`（或 `.env`）：端口、数据库连接、日志等级、undo TTL、允许跨域域名。
- 支持环境变量覆盖，Viper 自动加载。

### 4.6 可观测性

- 通过 `prometheus/client_golang` 暴露关键指标：请求时延、错误率、任务数量。
- 健康检查 `GET /healthz`：检查数据库连通性。

---

## 5. 数据库设计（MySQL 5.7）

### 5.1 表概览

| 表名 | 作用 |
|------|------|
| `tasks` | 任务主表，存储当前状态与排序信息 |
| `task_operations` | 撤销队列，记录操作前/后快照，配发 undo token |
| `task_activity_logs` | 长期审计/统计日志（非必需撤销，可离线分析） |
| `migrations` | 记录数据库迁移版本（go-migrate） |

### 5.2 `tasks`

```sql
CREATE TABLE tasks (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  uuid CHAR(36) NOT NULL UNIQUE,
  title VARCHAR(255) NOT NULL,
  notes TEXT NULL,
  deadline DATE NULL,
  status ENUM('now','future','history') NOT NULL DEFAULT 'future',
  sort_weight BIGINT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  completed_at DATETIME NULL,
  deleted_at DATETIME NULL,
  PRIMARY KEY (id),
  INDEX idx_status_deadline (status, deadline),
  INDEX idx_status_sort (status, sort_weight),
  INDEX idx_completed_at (completed_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

说明：

- `uuid` 面向前端使用，避免暴露自增 ID。
- `sort_weight`：`status` 内排序权重，默认取毫秒时间戳；手动调整顺序时重新计算，确保排序稳定。
- `deleted_at` 预留软删除能力；默认查询排除 soft delete。

### 5.3 `task_operations`

```sql
CREATE TABLE task_operations (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  token CHAR(26) NOT NULL UNIQUE,
  action ENUM('create','update','move','complete','delete','bulk_move','bulk_complete','bulk_delete','resort') NOT NULL,
  scope ENUM('single','bulk') NOT NULL DEFAULT 'single',
  task_ids JSON NOT NULL,
  before_state JSON NULL,
  after_state JSON NULL,
  expire_at DATETIME NOT NULL,
  consumed_at DATETIME NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  INDEX idx_token_expire (token, expire_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

说明：

- `token` 使用雪花算法或 NanoID 生成，默认 5 秒有效，前端 Toast 提供撤销。
- `before_state`/`after_state` 存储 JSON 数组，用于回滚。
- `task_ids` 方便批量回滚时过滤。

### 5.4 `task_activity_logs`

```sql
CREATE TABLE task_activity_logs (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  task_uuid CHAR(36) NOT NULL,
  action VARCHAR(32) NOT NULL,
  payload JSON NULL,
  actor VARCHAR(64) DEFAULT 'system',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  INDEX idx_task_uuid (task_uuid)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

说明：

- 用于数据回放、统计；不参与撤销，但可支持后续多设备同步、通知等需求。

### 5.5 迁移策略

- 使用 `golang-migrate` 管理 SQL；启动时读取 `MIGRATION_DIR` 并执行。
- 每次 schema 变更需更新迁移脚本与文档。
- 提供 `make migrate-up`、`make migrate-down` 命令。

---

## 6. 接口设计

### 6.1 约定

- **Base URL**：`/api/v1`。
- **请求格式**：`application/json`；批量接口 Body 为 JSON。
- **响应格式**：

```json
{
  "code": 0,
  "message": "ok",
  "data": { ... },
  "undoToken": "optional-token"
}
```

- **错误码**：
  - `0`：成功
  - `40001`：参数错误
  - `40400`：资源不存在
  - `40900`：非法状态流转（如历史任务不可再次完成）
  - `41000`：撤销 token 失效
  - `50000`：服务器错误

### 6.2 API 列表

| 方法 | 路径 | 说明 | 主要参数 | 撤销 |
|------|------|------|----------|------|
| GET | `/tasks` | 查询任务列表 | `status`、`keyword`、`deadlineFrom/To`、`page`、`pageSize` | 否 |
| POST | `/tasks` | 新增任务 | `title`、`notes?`、`deadline?`、`status?`、`sortWeight?` | 是 |
| GET | `/tasks/{uuid}` | 查询单个任务 | - | 否 |
| PUT | `/tasks/{uuid}` | 更新任务（全量） | `title`、`notes?`、`deadline?` | 是 |
| PATCH | `/tasks/{uuid}` | 局部更新 | 任意字段（标题、备注、deadline） | 是 |
| PATCH | `/tasks/{uuid}/status` | 状态流转 | `status`、`sortWeight?` | 是 |
| POST | `/tasks/{uuid}/complete` | 完成任务 → History | `completedAt?` | 是 |
| DELETE | `/tasks/{uuid}` | 删除任务 | `hardDelete?` | 是 |
| POST | `/tasks/bulk/move` | 批量移动 | `ids[]`、`targetStatus` | 是 |
| POST | `/tasks/bulk/complete` | 批量完成 | `ids[]` | 是 |
| POST | `/tasks/bulk/delete` | 批量删除 | `ids[]` | 是 |
| POST | `/tasks/order` | 更新列表顺序 | `status`、`orderedIds[]` | 是 |
| POST | `/undo` | 撤销操作 | `token` | 否（执行成功返回新的 undoToken，支持链式撤销） |
| GET | `/healthz` | 健康检查 | - | 否 |

### 6.3 示例

**新增任务**

```http
POST /api/v1/tasks
Content-Type: application/json

{
  "title": "准备周报",
  "status": "future",
  "deadline": "2025-11-05"
}
```

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "uuid": "c21e7b3c-...",
    "title": "准备周报",
    "status": "future",
    "deadline": "2025-11-05",
    "sortWeight": 1730515200000,
    "createdAt": "2025-11-02T08:00:00Z"
  },
  "undoToken": "UN023XK7P4YV6H"
}
```

**撤销**

```http
POST /api/v1/undo
Content-Type: application/json

{ "token": "UN023XK7P4YV6H" }
```

```json
{
  "code": 0,
  "message": "rolled back",
  "data": {
    "affectedIds": ["c21e7b3c-..."]
  }
}
```

### 6.4 排序与分页

- 列表默认分页 `pageSize=50`，历史列表支持 `page` + `completedAt<cursor`。
- `orderedIds` 接口允许前端在同列保存手动顺序；后端重新计算 `sort_weight` 防止溢出。

---

## 7. 核心业务流程

1. **每日规划**
   - 前端加载 `future` 列，排序后展示最紧急任务；用户批量选择 3–5 条 → `bulk/move` → 进入 `now` → Toast + Undo。

2. **执行任务**
   - 拖拽卡片至完成区或点击「完成」按钮 → `POST /tasks/{id}/complete` → 任务移至历史列表，`completedAt` 记录当前时间。

3. **撤销**
   - 用户在 5 秒内点击 Toast 的「撤销」 → `POST /undo` → 后端恢复 `tasks` 表数据，返还最新列表快照。

4. **批量截止日**
   - 前端弹窗选择日期 → `PATCH /tasks/{id}`（串行）或新增 `/tasks/bulk/deadline`（预留）。

5. **移动端长按多选**
   - 长按卡片 → `selectionStore` 进入批量模式 → 显示底部操作条 → 调用批量接口。

---

## 8. 非功能需求

- **性能**：首次加载 < 2s；列表滚动流畅（虚拟列表可按需实现）。
- **可靠性**：后端接口覆盖单元测试；关键服务带超时与重试；MySQL 连接池配置合理。
- **安全性**：开启 CORS 白名单；对外 API 默认无鉴权（后续可接入用户体系）。
- **日志**：按请求记录操作明细与回滚情况；数据库慢查询日志开启。
- **国际化**：目前仅中文，文案集中存储，方便后续扩展。

---

## 9. 开发流程与工具

- `npm install && npm run dev` 启动前端；`go run .` 启动后端；`docker-compose up` 一键拉起 MySQL。
- 推进顺序建议：
  1. 定义 API 与数据模型 → 完成 migrations。
  2. 实现后端 Service/Handler → 自测 Postman。
  3. 前端搭建骨架、状态管理、接口对接。
  4. 实现拖拽、多选、撤销等交互。
  5. 编写单元/端到端测试。
- 手动联调可打开 `backend/tests/api-playground.html`，覆盖所有 REST 接口的示例请求。
- 代码评审遵循 Conventional Commit；提交前运行 lint+test。

---

## 10. 风险与应对

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 多端拖拽体验不一致 | 移动端操作困难 | 提供长按手势、底部操作条备选交互；对拖拽库进行手势调优 |
| 撤销与排序冲突 | 数据错乱 | 操作写入前记录完整快照，撤销时刷新相关列表 |
| MySQL 与前端缓存不一致 | 用户看到旧数据 | 所有写操作返回最新任务快照；前端命中后刷新列表 |
| 批量操作耗时 | UI 卡顿 | 后端使用事务+批量更新；前端乐观提示 |
| 容量提示被忽略 | 体验弱化 | 前端/后端双重提醒，返回 `capacityWarning` 字段 |

---

## 11. 未来扩展

- 多用户与鉴权：引入用户表、OAuth/OIDC；任务表增加 `owner_id`。
- 实时同步：基于 WebSocket/Server-Sent Events 推送任务变更。
- 推送提醒：结合定时任务，读取 `deadline` 推送通知。
- 数据分析：利用 `task_activity_logs` 统计完成率、逾期率。

---

## 12. 总结

本方案在前端选用 Vue 生态满足 PC+移动端适配，在后端采用 Go + Gin + GORM + MySQL 5.7，确保高性能与易扩展。通过统一的排序与撤销机制、完善的数据库设计与接口契约，可以支撑原型所需的任务管理体验，并为后续多端同步与高级功能预留空间。

