# Windows 11 WSL 编译 Go 项目到 CentOS 7.8 使用示例

## 快速使用步骤

### 1. 编译项目（三选一）

#### 方法一：Windows 批处理（最简单）
```cmd
# 进入 backend 目录
cd backend

# 运行编译脚本
build.bat
```

#### 方法二：WSL 环境
```bash
# 在 WSL 中进入项目目录
cd /mnt/d/WorkSpace/code/2025/todolist/backend

# 给脚本执行权限
chmod +x build.sh

# 运行编译
./build.sh
```

#### 方法三：手动命令
```cmd
# 设置环境变量
set GOOS=linux
set GOARCH=amd64
set CGO_ENABLED=0

# 编译
go build -ldflags="-w -s" -o todolist-server main.go
```

### 2. 部署到 CentOS 7.8

#### 手动部署
```bash
# 传输文件到服务器
scp backend/todolist-server root@192.168.1.100:/opt/todolist/

# 登录服务器
ssh root@192.168.1.100

# 创建用户和目录
useradd -r -s /bin/false todolist
mkdir -p /opt/todolist/{bin,logs,config}
chown -R todolist:todolist /opt/todolist

# 移动文件到正确位置
mv /opt/todolist/todolist-server /opt/todolist/bin/
chmod +x /opt/todolist/bin/todolist-server

# 配置 systemd 服务
cp todolist.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable todolist
systemctl start todolist

# 查看状态
systemctl status todolist
```

#### 自动化部署
```bash
# 使用部署脚本
./deploy.sh root@192.168.1.100 /opt/todolist
```

### 3. 验证部署

```bash
# 检查服务状态
sudo systemctl status todolist

# 查看日志
sudo journalctl -u todolist -f

# 测试 API
curl -I http://localhost:8080/
```

## 实际编译输出示例

运行 `build.bat` 后的输出：

```
开始编译 Go 项目到 CentOS 7.8...
编译目标: linux/amd64
版本信息: a446dba
构建时间: 2025-11-03_10:04:39
编译成功!
输出文件: todolist-server
文件大小: 11948216 字节
部署步骤:
1. 传输到服务器: scp todolist-server user@server:/path/
2. 在服务器上运行: chmod +x todolist-server && ./todolist-server
```

## 文件大小对比

- Windows 编译（开发）：~15MB
- Linux 静态编译（生产）：~12MB
- UPX 压缩后：~4MB（可选）

## 常见问题解决

### 问题1：中文字符乱码
**解决方案**：批处理文件的中文显示问题不影响功能，编译仍会成功。

### 问题2：权限被拒绝
```bash
# 在 CentOS 服务器上
chmod +x todolist-server
# 或
chcon -t bin_t todolist-server  # 如果是 SELinux 问题
```

### 问题3：端口被占用
```bash
# 查找占用端口的进程
netstat -tlnp | grep :8080
# 或
ss -tlnp | grep :8080

# 杀死进程
kill -9 <PID>
```

### 问题4：服务启动失败
```bash
# 查看详细日志
sudo journalctl -u todolist -n 50

# 检查配置
sudo systemctl daemon-reload
sudo systemctl restart todolist
```

## 生产环境优化

### 1. 使用 UPX 压缩（可选）
```bash
# 安装 UPX
sudo apt install upx-ucl

# 压缩二进制文件
upx --best todolist-server
```

### 2. 配置反向代理（Nginx）
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. 配置 HTTPS
```bash
# 使用 Let's Encrypt
sudo certbot --nginx -d your-domain.com
```

## 监控和维护

### 日志查看
```bash
# 实时查看日志
sudo journalctl -u todolist -f

# 查看最近的日志
sudo journalctl -u todolist --since "1 hour ago"
```

### 服务管理
```bash
# 重启服务
sudo systemctl restart todolist

# 重新加载配置
sudo systemctl reload todolist

# 停止服务
sudo systemctl stop todolist
```

### 更新部署
```bash
# 停止服务
sudo systemctl stop todolist

# 备份当前版本
cp /opt/todolist/bin/todolist-server /opt/todolist/bin/todolist-server.backup

# 上传新版本
scp new-todolist-server root@server:/opt/todolist/bin/todolist-server

# 启动服务
sudo systemctl start todolist
```

## 安全建议

1. **防火墙配置**
```bash
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload
```

2. **用户权限**
```bash
# 使用非 root 用户运行
sudo useradd -r -s /bin/false todolist
sudo chown -R todolist:todolist /opt/todolist
```

3. **SELinux 配置**
```bash
# 检查 SELinux 状态
sestatus

# 设置正确的上下文
sudo chcon -t bin_t /opt/todolist/bin/todolist-server
```

这个完整的解决方案确保了您可以在 Windows 11 WSL 环境中轻松编译 Go 项目并部署到 CentOS 7.8 服务器。
